---
title: 网络编程 - 概述
date: 2018-10-25 17:48:53
tags: 网络
---
首先看一张经典的图：
![网络七层、四层模型.png](https://upload-images.jianshu.io/upload_images/2855070-78758cae41145011.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
说到网络编程一般都会说到OSI参考模型和TCP/IP模型，这篇文章主要从TCP/IP模型出发，谈谈我对网络编程的理解。
TCP/IP模型分为四层，从下到上分别是网络接口层、网络层、传输层、应用层。越往下越靠近硬件，越往上越接近用户。每一层的分工不同，为了实现每一层的功能，制定了一些规则，这些规则就是**协议**。
## 网络接口层
### 以太网协议
以太网协议确定了一系列的约定，让一股又一股的电流能够传递信息：0 或者 1。它规定一组信号组成一个数据包“帧”，每一帧有两部分组成：标头（Head）和数据（Data)。

![以太网.jpg](https://upload-images.jianshu.io/upload_images/2855070-3b70a3bb7412e92d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- “标头”包括目的地址、源地址、类型，长度固定为18字节。
- “数据”就是数据包的具体内容，最短为46字节，最长为1500字节，如果超出这个长度，就必须分割成多个帧进行发送。

### MAC地址
在“标头”里，我们如何标识目的地址和源地址？这时候就需要MAC地址了。
以太网规定，连入网络的所有设备，都必须具有"网卡"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。每一张网卡都有唯一的MAC地址，由厂商向 IEEE 购买，再预先烧录进芯片里，每个有线网卡、每台路由器、每个无线网卡甚至每个蓝牙芯片都有自己的唯一 MAC 地址。
MAC地址长度是48个二进制位，通常用12个十六进制数表示，比如：AA:BB:CC:DD:EE:FF。前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号。有了MAC地址，就可以定位网卡和数据包的路径了。
### 类型
类型具有两个意义，当这两个字节的值小于1518时，那么它就代表其后数据字段的长度；如果这两个字节的值大于1518，则表示该以太网帧中的数据属于哪个上层协议（例如0x800，代表IP数据包；0x806，代表ARP数据包等）。
### 广播
我们怎么把数据发送给对方呢？
1. 我们要知道对方的地址
2. 我们知道地址后把数据包准确的发送给对方

怎么知道对方的MAC地址呢？这里通过ARP协议。这个放在IP协议里面说。那怎么发送数据呢？
举个例子：A同学到一个班级里面想找B同学，但是不知道他是谁。于是他就在那个班级里面喊一句：B同学你们喊你回家吃饭。然后B同学就接收到这个信息了，B同学对此就可以做出回应。
![timg.jpeg](https://upload-images.jianshu.io/upload_images/2855070-bb9d05c40e1c3a41.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
翻译一下就是：A计算机要向B计算发送数据包，但是在这个网络里还有C、D、E、F四台计算机。A发送数据包后，B、C、D、E、F都会收到这个包，他们读取这个包的“标头”，找到接收者的MAC地址，然后和自己的对比。如果相同，就做处理。如果不同，就弃包。这种发送方式就叫“广播”。至此，就可以在多台计算机之间传递信息了。
## 网络层
既然我们可以在多台计算机之间传递信息了，为什么还有网络层呢？
我们知道，计算机通过“广播”的方式传递信息，它只局限于发送者所在的子网内，我们不能保证发送者和接收者都在一个子网内（如果没有这种子网设计，全世界的计算机都能接收到信息，这将是一场灾难）。
所以，我们采取了一种方法：当发送者和接收者都在一个子网内，采取“广播”方式发送，不在一个子网内，采取“路由”方式发送。
这就导致了"网络层"的诞生。它的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做"网络地址"，简称"网址"。从此每台计算机有了两种地址，一种是MAC地址，另一种是网络地址。两种地址之间没有任何联系，MAC地址是绑定在网卡上的，网络地址则是管理员分配的，它们只是随机组合在一起。通过网络地址，我们可以得出计算机所在的子网络。
### IP协议
IP协议：用来规定网络地址的协议。目前广泛采用的IP协议是第四版，简称IPv4，它有32个二进制组成（即32位）。目前IPv6正在推广，它是128位。
![IP协议.jpg](https://upload-images.jianshu.io/upload_images/2855070-f8bca9920a27fb46.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
- 首部主要包括总长度、源地址、目的地址等信息。
1.总长度界定了本次 ip 报文的长度，便于读取有效数据
2.源地址指本次 ip 报文是由那个 ip 地址发出的
3.目的地址指本次 ip 报文需要发给哪一台设备
- 数据部分是IP数据包的具体内容。
- 以太网数据包的数据部分就是整个IP数据

在介绍以太网帧的时候，以太网帧也有数据部分，便是IP数据包。
IP数据包的"标头"部分的长度为20到60字节，整个数据包的总长度最大为65,535字节。因此，理论上，一个IP数据包的"数据"部分，最长为65,515字节。前面说过，以太网数据包的"数据"部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。
### ARP协议
ARP协议，即地址解析协议(Address Resolution Protoco)，它是通过IP地址获取MAC地址的协议。
举个例子：
A的IP地址是192.168.1.1，MAC地址是0A-11-22-33-44-01
B的IP地址是192.168.1.2，MAC地址是0A-11-22-33-44-02
当A要与B通信时，ARP协议将B的IP地址解析成MAC地址。流程如下：
1. A确定自己要寻找的是192.168.1.2的IP地址，在本地ARP缓存中检查B的匹配MAC地址，如果找到，A向B进行IP通信。
2. 如果A没有在ARP缓存中找到B的MAC地址，它将询问192.168.1.2的MAC地址，从而将ARP请求帧广播到本地网络上的所有主机。本地网络上的每台主机都会将收到ARP请求并与自己的IP地址匹配。如果发现请求的IP地址和自己的IP地址不一样，它将放弃ARP请求。
3. B收到ARP请求后，发现请求的IP地址与自己的IP地址一样，将A的IP地址和MAC地址映射添加到本地ARP缓存中。
4. B将包含MAC地址的ARP回复消息发送给A。
5. A收到B的ARP回复消息后，将B的IP和MAC地址映射更新ARP缓存（ARP缓存有生命期，当生命期接收后，再次重复上面过程）。A确定B的MAC地址后，进行IP通信。
![ARP.png](https://upload-images.jianshu.io/upload_images/2855070-5736df1c662b58e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
但是，ARP 只能用于 IPv4 ，不能用于 IPv6。在IPv6 中可以用 ICMPv6 替代 ARP。
## 传输层
有了MAC地址和IP地址，不管我们在不在一个子网内，我们都可以建立通信了。
但是，我们怎么知道对方发来的数据包，是供哪个程序使用呢？比如说我现在一边浏览网页，一边聊天。我接收到的数据包，是网页的内容？还是聊天内容？
这个时候我们就需要一个参数，表示这个数据包到底供哪个程序（进程）使用。这个参数就叫做"端口"，它其实是每一个使用网卡的程序的编号。每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。
传输层的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。
### TCP协议
传输层不止TCP协议，还有UDP协议。这里我们简单介绍一下TCP协议，来了解传输层的做了什么。
![TCP.jpg](https://upload-images.jianshu.io/upload_images/2855070-6b909534f1a54995.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
TPC协议里包含了首部和数据部分。
- 首部最重要的是源端口和目的端口。
- 数据部分就是具体的内容。
- IP数据包的数据部分就是整个TCP数据。
## 应用层
应用层是在用户空间实现的，负责处理众多业务逻辑，如文件传输、网络管理。它规定了应用程序的数据格式。
![all.jpg](https://upload-images.jianshu.io/upload_images/2855070-276d7c74a3257052.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

至此，我们就大概了解到TCP/IP模型，四层做了什么。如有错误之处，还望各位指出。

参考：
[软件工程师需要了解的网络知识系列](https://lvwenhan.com/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/485.html)
[网络编程懒人入门](http://www.52im.net/thread-1095-1-1.html)





